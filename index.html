<html><head>
<meta charset="UTF-8"><link rel="manifest" href="/manifest.json"><title>Blocktron17Start</title>
</head>
<style>
  #errorModal, #httpsWarningModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .modal-content {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    max-width: 80%;
    max-height: 80%;
    overflow-y: auto;
  }
  .modal-content h2 {
    color: #ff0000;
  }
  .modal-content pre {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .modal-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }
  .modal-buttons button {
    padding: 5px 10px;
    cursor: pointer;
  }
  body {
    background-color: #2e2e2e;
    color: #f5f5f5;
    font-family: 'Arial', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    background-image: url('');
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
  }
  .loading-bar-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background-color: #000;
    z-index: 9999;
  }
  .loading-bar {
    height: 100%;
    background-color: #4a90e2;
    width: 0%;
    transition: width 2s;
  }
  .loading-bar.active {
    width: 100%;
  }
  .search-container {
    position: fixed;
    top: 20px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .search-container form {
    display: flex;
    align-items: center;
    margin-right: 10px;
  }
  .search-container input[type="text"] {
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    width: 300px;
  }
  .search-container input[type="submit"] {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    background-color: #4a90e2;
    color: #fff;
    cursor: pointer;
    margin-left: 10px;
  }
  .shortcuts {
    margin-top: 200px;
  }
  .shortcut {
    display: inline-block;
    background-color: #414141;
    color: #fff;
    padding: 10px 15px;
    border-radius: 4px;
    margin: 5px;
    cursor: pointer;
  }
  .checkbox {
    display: none;
    margin-right: 10px;
  }
  .buttons {
    margin-top: 20px;
  }
  .buttons button, #settingsBtn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    background-color: #4a90e2;
    color: #fff;
    cursor: pointer;
    margin: 0 10px;
  }
  #addShortcutModal, #settingsModal {
    display: none;
  }
  #doneBtn {
    display: none;
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    background-color: #4a90e2;
    color: #fff;
    cursor: pointer;
    margin-top: 20px;
  }
  #settingsModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #3a3a3a;
    padding: 20px;
    border-radius: 8px;
  }
  #settingsModal input, #settingsModal select {
    margin: 10px 0;
    padding: 10px;
    border-radius: 4px;
  }
</style>
</head>
<body>
  <div class="loading-bar-container">
    <div class="loading-bar" id="loadingBar"></div>
  </div>
  
  <div class="search-container">
    <form id="searchForm" action="https://google.com/search" method="GET">
      <input type="text" name="q" placeholder="Search or enter a URL...">
      <input type="submit" value="Go">
    </form>
    <button id="settingsBtn">Settings</button>
  </div>
  
  <div class="shortcuts" id="shortcuts">
  </div>
  
  <div class="buttons">
    <button id="addShortcutBtn">Add Shortcut</button>
    <button id="removeShortcutBtn">Remove Shortcuts</button>
    <button id="doneBtn">Done</button>
  </div>
  
  <div id="addShortcutModal">
    <form id="addShortcutForm">
      <input type="text" id="newShortcutName" placeholder="Shortcut Name">
      <input type="text" id="newShortcutURL" placeholder="Shortcut URL">
      <button type="submit">Add</button>
    </form>
  </div>
  
  <div id="settingsModal">
    <div>
      <label for="themeToggle">Theme:</label>
      <select id="themeToggle">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </div>
    <div>
      <label for="searchEngineSelect">Search Engine:</label>
      <select id="searchEngineSelect">
        <option value="https://google.com/search">Google</option>
        <option value="https://bing.com/search">Bing</option>
        <option value="https://duckduckgo.com">DuckDuckGo</option>
      </select>
    </div>
    <div>
      <label for="backgroundUpload">Background Image:</label>
      <input type="file" id="backgroundUpload" accept="image/*">
    </div>
    <button id="saveSettingsBtn">Save</button>
  </div>
  
  <script>
    function activateLoadingBar() {
      const loadingBar = document.getElementById('loadingBar');
      loadingBar.classList.add('active');
    }

    function stopLoadingBar() {
      const loadingBar = document.getElementById('loadingBar');
      loadingBar.classList.remove('active');
    }

    async function navigateTo(url) {
      activateLoadingBar();
      try {
        const httpsSupported = await checkHttpsSupport(url);
        if (!httpsSupported) {
          showHttpsWarningModal(url);
        } else {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          document.body.appendChild(iframe);
          
          iframe.onload = () => {
            stopLoadingBar();
            document.body.removeChild(iframe);
            window.location.href = url;
          };

          iframe.onerror = (error) => {
            stopLoadingBar();
            document.body.removeChild(iframe);
            showErrorModal(error);
          };

          iframe.src = url;
        }
      } catch (error) {
        stopLoadingBar();
        showErrorModal(error);
      }
    }

    async function checkHttpsSupport(url) {
      if (url.startsWith('http://')) {
        url = url.replace('http://', 'https://');
      } else if (!url.startsWith('https://')) {
        url = 'https://' + url;
      }

      try {
        const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
        return true;
      } catch (error) {
        return false;
      }
    }

    function showHttpsWarningModal(url) {
      stopLoadingBar();
      const modal = document.createElement('div');
      modal.id = 'httpsWarningModal';
      modal.innerHTML = `
        <div class="modal-content">
          <h2>HTTPS Not Supported</h2>
          <p>The website you're trying to access does not support HTTPS. This could pose security risks.</p>
          <div class="modal-buttons">
            <button id="continueBtn">Continue to Site</button>
            <button id="closeWarningBtn">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('continueBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
        window.location.href = url.replace('https://', 'http://');
      });

      document.getElementById('closeWarningBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    }

    function showErrorModal(error) {
      stopLoadingBar();
      const modal = document.createElement('div');
      modal.id = 'errorModal';
      modal.innerHTML = `
        <div class="modal-content">
          <h2>Error Loading Page</h2>
          <p>${error.message || 'An error occurred while loading the page.'}</p>
          <div id="errorDetails" style="display: none;">
            <pre>${error.stack || 'No additional error details available.'}</pre>
          </div>
          <div class="modal-buttons">
            <button id="viewMoreBtn">View More</button>
            <button id="closeErrorBtn">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('viewMoreBtn').addEventListener('click', () => {
        document.getElementById('errorDetails').style.display = 'block';
      });

      document.getElementById('closeErrorBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    }

    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.querySelector('input[name="q"]').value;
      localStorage.setItem('lastSearch', input);
      
      // Check if input is a URL or domain
      const urlRegex = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
      if (urlRegex.test(input)) {
        // If it's a URL or domain, redirect directly
        let url = input;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        navigateTo(url);
      } else {
        // If it's not a URL, perform a search
        const searchEngine = localStorage.getItem('searchEngine') || "https://google.com/search";
        navigateTo(`${searchEngine}?q=${encodeURIComponent(input)}`);
      }
    });

    document.getElementById('addShortcutBtn').addEventListener('click', function() {
      const modal = document.getElementById('addShortcutModal');
      modal.style.display = 'block';
    });

    document.getElementById('addShortcutForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const name = document.getElementById('newShortcutName').value;
      const url = document.getElementById('newShortcutURL').value;
      const shortcutsDiv = document.getElementById('shortcuts');
      const newShortcut = document.createElement('div');
      newShortcut.className = 'shortcut-container';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'checkbox';
      checkbox.id = name + '-checkbox';
      const shortcut = document.createElement('div');
      shortcut.className = 'shortcut';
      shortcut.innerText = name;
      shortcut.setAttribute('data-url', url);
      shortcut.addEventListener('click', () => navigateTo(url));
      newShortcut.appendChild(checkbox);
      newShortcut.appendChild(shortcut);
      shortcutsDiv.appendChild(newShortcut);
      document.getElementById('addShortcutModal').style.display = 'none';
      
      saveShortcuts();
    });

    let removingShortcuts = false;

    document.getElementById('removeShortcutBtn').addEventListener('click', function() {
      removingShortcuts = !removingShortcuts;
      const doneBtn = document.getElementById('doneBtn');
      const checkboxes = document.querySelectorAll('.checkbox');
      doneBtn.style.display = removingShortcuts ? 'block' : 'none';
      checkboxes.forEach(checkbox => {
        checkbox.style.display = removingShortcuts ? 'block' : 'none';
      });
    });
    
    document.getElementById('doneBtn').addEventListener('click', function() {
      const checkboxes = document.querySelectorAll('.checkbox');
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          checkbox.parentElement.remove();
        } else {
          checkbox.style.display = 'none';
        }
      });
      document.getElementById('doneBtn').style.display = 'none';
      removingShortcuts = false;

      saveShortcuts();
    });

    document.getElementById('settingsBtn').addEventListener('click', function() {
      document.getElementById('settingsModal').style.display = 'block';
    });

    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
      const theme = document.getElementById('themeToggle').value;
      const searchEngine = document.getElementById('searchEngineSelect').value;
      const backgroundUpload = document.getElementById('backgroundUpload').files[0];

      if (backgroundUpload) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.body.style.backgroundImage = `url(${e.target.result})`;
          localStorage.setItem('background', e.target.result);
        };
        reader.readAsDataURL(backgroundUpload);
      }

      document.body.style.backgroundColor = theme === 'dark' ? '#2e2e2e' : '#f5f5f5';
      document.body.style.color = theme === 'dark' ? '#f5f5f5' : '#000';
      localStorage.setItem('theme', theme);
      localStorage.setItem('searchEngine', searchEngine);
      document.getElementById('settingsModal').style.display = 'none';
    });

    function saveShortcuts() {
      const shortcuts = [];
      document.querySelectorAll('.shortcut-container').forEach(shortcutContainer => {
        const shortcut = shortcutContainer.querySelector('.shortcut');
        shortcuts.push({
          name: shortcut.innerText,
          url: shortcut.getAttribute('data-url')
        });
      });

      localStorage.setItem('shortcuts', JSON.stringify(shortcuts));
    }

    function loadSettings() {
      const theme = localStorage.getItem('theme');
      if (theme) {
        document.body.style.backgroundColor = theme === 'dark' ? '#2e2e2e' : '#f5f5f5';
        document.body.style.color = theme === 'dark' ? '#f5f5f5' : '#000';
        document.getElementById('themeToggle').value = theme;
      }

      const searchEngine = localStorage.getItem('searchEngine') || "https://google.com/search";
      document.getElementById('searchEngineSelect').value = searchEngine;

      const shortcuts = JSON.parse(localStorage.getItem('shortcuts') || "[]");
      const shortcutsDiv = document.getElementById('shortcuts');
      shortcuts.forEach(shortcut => {
        const newShortcut = document.createElement('div');
        newShortcut.className = 'shortcut-container';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.id = shortcut.name + '-checkbox';
        const div = document.createElement('div');
        div.className = 'shortcut';
        div.innerText = shortcut.name;
        div.setAttribute('data-url', shortcut.url);
        div.addEventListener('click', () => navigateTo(shortcut.url));
        newShortcut.appendChild(checkbox);
        newShortcut.appendChild(div);
        shortcutsDiv.appendChild(newShortcut);
      });

      const background = localStorage.getItem('background');
      if (background) {
        document.body.style.backgroundImage = `url(${background})`;
      }
    }

    loadSettings();

    // Add error event listener to window object
    window.addEventListener('error', function(event) {
      showErrorModal({
        message: 'An error occurred on the page:',
        stack: `${event.message} at ${event.filename}:${event.lineno}:${event.colno}`
      });
    });

    // Override fetch to catch network errors
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      return originalFetch.apply(this, args).catch(error => {
        showErrorModal(error);
        throw error;
      });
    };
  </script>
</body>
</html>
